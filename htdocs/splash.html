<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>$gatewayname - Internet Access</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #e4e4e4;
}
.container {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}
.header { text-align: center; margin-bottom: 25px; }
.header h1 { font-size: 1.5rem; margin-bottom: 8px; color: #fff; }
.time-badge {
    display: inline-block;
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
}
.header p { margin-top: 15px; font-size: 0.95rem; color: #a0a0a0; line-height: 1.5; }
.chat-container {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 20px;
    max-height: 300px;
    overflow-y: auto;
}
.message {
    margin-bottom: 12px;
    padding: 12px 15px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.4;
}
.message.user { background: #4a69bd; margin-left: auto; border-bottom-right-radius: 4px; }
.message.assistant { background: rgba(255, 255, 255, 0.1); margin-right: auto; border-bottom-left-radius: 4px; }
.message.system { background: rgba(255, 193, 7, 0.15); color: #ffc107; text-align: center; max-width: 100%; font-size: 0.9rem; }
.message.approved { background: rgba(46, 213, 115, 0.15); color: #2ed573; text-align: center; max-width: 100%; }
.message.denied { background: rgba(255, 107, 107, 0.15); color: #ff6b6b; text-align: center; max-width: 100%; }
.input-area { display: flex; gap: 10px; }
textarea {
    flex: 1;
    padding: 15px;
    border: none;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 1rem;
    resize: none;
    height: 60px;
    font-family: inherit;
}
textarea:focus { outline: 2px solid #4a69bd; }
textarea::placeholder { color: #666; }
button, input[type="submit"] {
    padding: 15px 25px;
    border: none;
    border-radius: 12px;
    background: #4a69bd;
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
    font-weight: 500;
}
button:hover:not(:disabled), input[type="submit"]:hover { background: #3c5aa6; }
button:disabled { opacity: 0.5; cursor: not-allowed; }
.loading { display: none; text-align: center; padding: 15px; }
.loading.active { display: block; }
.spinner {
    width: 30px; height: 30px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top-color: #4a69bd;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.rules {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    font-size: 0.85rem;
}
.rules h3 { margin-bottom: 10px; font-size: 0.9rem; color: #a0a0a0; }
.rules ul { list-style: none; padding-left: 0; }
.rules li { padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
.rules li:last-child { border-bottom: none; }
.rules .duration { color: #4a69bd; font-weight: 500; }
.hidden { display: none; }
/* NDS form - hidden, used for actual auth */
#nds-form { display: none; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Nighttime Access Request</h1>
        <span class="time-badge" id="currentTime"></span>
        <p>It's late. Please explain why you need internet access right now.</p>
    </div>

    <div class="rules">
        <h3>Access Guidelines</h3>
        <ul>
            <li><span class="duration">10 min</span> - Quick check that can't wait</li>
            <li><span class="duration">60 min</span> - Work/school tasks due TODAY</li>
            <li><span class="duration">120 min</span> - Video calls, meetings</li>
        </ul>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="message assistant">
            Hi! It's after 9pm. Why do you need internet access right now? I'll evaluate if it's urgent enough.
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>Evaluating your request...</span>
    </div>

    <div class="input-area" id="inputArea">
        <textarea id="userInput" placeholder="Explain why you need internet access..."></textarea>
        <button type="button" id="sendBtn">Send</button>
    </div>

    <!-- Hidden NDS authentication form -->
    <form id="nds-form" method="GET" action="$authaction">
        <input type="hidden" name="tok" value="$tok">
        <input type="hidden" name="redir" value="$redir">
    </form>
</div>

<script>
// NDS variables passed from server
var NDS = {
    tok: '$tok',
    redir: '$redir',
    authaction: '$authaction',
    clientip: '$clientip',
    clientmac: '$clientmac',
    gatewayname: '$gatewayname'
};

var API_URL = 'http://192.168.8.1:2051/chat';
var sessionId = null;

function updateTime() {
    var now = new Date();
    var h = now.getHours();
    var m = now.getMinutes();
    var ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    m = m < 10 ? '0' + m : m;
    document.getElementById('currentTime').textContent = h + ':' + m + ' ' + ampm;
}
updateTime();
setInterval(updateTime, 60000);

function addMessage(content, type) {
    var container = document.getElementById('chatContainer');
    var msg = document.createElement('div');
    msg.className = 'message ' + type;
    msg.textContent = content;
    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
}

function setLoading(active) {
    document.getElementById('loading').className = active ? 'loading active' : 'loading';
    document.getElementById('inputArea').className = active ? 'input-area hidden' : 'input-area';
}

function disableInput() {
    document.getElementById('inputArea').className = 'input-area hidden';
}

function authenticateWithNDS() {
    // Submit the hidden NDS form to complete authentication
    document.getElementById('nds-form').submit();
}

function sendMessage() {
    var input = document.getElementById('userInput');
    var message = input.value.trim();
    if (!message) return;

    addMessage(message, 'user');
    input.value = '';
    setLoading(true);

    var xhr = new XMLHttpRequest();
    xhr.open('POST', API_URL, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            setLoading(false);
            try {
                var data = JSON.parse(xhr.responseText);
                if (data.session_id) sessionId = data.session_id;

                if (data.status === 'question') {
                    addMessage(data.message, 'assistant');
                } else if (data.status === 'approved') {
                    addMessage('Access Granted for ' + data.duration + ' minutes!', 'approved');
                    addMessage(data.message, 'assistant');
                    addMessage('Connecting you to the internet...', 'system');
                    disableInput();
                    // Wait a moment then authenticate with NDS
                    setTimeout(authenticateWithNDS, 2000);
                } else if (data.status === 'denied') {
                    addMessage('Access Denied', 'denied');
                    addMessage(data.message, 'assistant');
                    addMessage('Try again in the morning, or with a different reason.', 'system');
                } else if (data.status === 'error') {
                    addMessage('Error: ' + data.message, 'system');
                }
            } catch(e) {
                addMessage('Connection error. Please try again.', 'system');
            }
        }
    };
    xhr.onerror = function() {
        setLoading(false);
        addMessage('Network error. Please try again.', 'system');
    };
    xhr.send(JSON.stringify({
        session_id: sessionId,
        mac: NDS.clientmac,
        ip: NDS.clientip,
        tok: NDS.tok,
        message: message
    }));
}

// Event listeners
document.getElementById('sendBtn').onclick = sendMessage;
document.getElementById('userInput').onkeydown = function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
};
</script>
</body>
</html>
